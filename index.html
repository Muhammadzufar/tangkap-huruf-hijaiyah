<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Game: Tangkap Huruf</title>
    <style>
        /* --- CSS Reset & Global Styles --- */
        :root {
            --bg-color: #e0f7fa;
            --header-bg: #00796b;
            --header-text: #ffffff;
            --button-bg: #ffc107;
            --button-hover-bg: #ffa000;
            --control-panel-bg: var(--header-bg); /* Unified with header */
            --bubble-bg: linear-gradient(145deg, #ffffff, #a7ffeb);
            --bubble-shadow: #b0bec5;
            --text-color: #004d40;
            --button-text-color: #004d40;
            --score-color: #d32f2f;
            --target-bg: #ffeb3b;
            --font-family: Arial, sans-serif; /* Reverted font */
        }

        * {
            box-sizing: border-box;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        @keyframes animated-gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: var(--font-family);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #e0f7fa, #b2ebf2, #80deea, #4dd0e1);
            background-size: 300% 300%;
            animation: animated-gradient 15s ease-in-out infinite;
        }

        /* --- Animations --- */
        @keyframes screen-shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }
        .shake-effect { animation: screen-shake .5s ease-in-out; }

        @keyframes screen-flash-correct { from { background-color: rgba(178, 255, 89, 0.7); } to { background-color: transparent; } }
        .flash-correct::after { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; animation: screen-flash-correct .4s ease-out; pointer-events: none; z-index: 2000; }

        @keyframes screen-flash-wrong { from { background-color: rgba(255, 138, 128, 0.7); } to { background-color: transparent; } }
        .flash-wrong::after { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; animation: screen-flash-wrong .4s ease-out; pointer-events: none; z-index: 2000; }

        @keyframes score-pop { 0% { transform: scale(1); } 50% { transform: scale(1.5); } 100% { transform: scale(1); } }
        .score-popped { animation: score-pop .3s ease-out; }

        @keyframes fall { 0% { transform: translateY(0) rotateZ(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotateZ(720deg); opacity: 0; } }
        .confetti { position: fixed; width: 10px; height: 10px; background-color: #f00; opacity: 0; z-index: 1000; pointer-events: none; animation: fall 3s ease-out forwards; }

        /* --- Start Screen --- */
        #start-screen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 5000;
            flex-direction: column;
            color: #fff;
            text-align: center;
            padding: 20px;
        }

        #start-screen-overlay h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        #lang-selection-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
            gap: 15px;
            margin-top: 20px;
        }

        .lang-select-btn {
            font-size: 1.2em;
            padding: 15px 25px;
            border-radius: 15px;
            border: none;
            background-color: var(--button-bg);
            color: var(--text-color);
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: all .2s;
            font-weight: bold;
        }

        .lang-select-btn:hover {
            background-color: var(--button-hover-bg);
            transform: scale(1.05);
        }

        #start-game-btn {
            font-size: 1.5em;
            padding: 15px 30px;
            border-radius: 15px;
            border: none;
            background-color: var(--button-bg);
            color: var(--text-color);
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: all .2s;
            font-weight: bold;
        }

        #start-game-btn:hover {
            background-color: var(--button-hover-bg);
            transform: scale(1.05);
        }

        /* --- Header --- */
        header {
            background: var(--header-bg);
            color: var(--header-text);
            padding: 10px 20px;
            z-index: 100;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .stat-section {
            text-align: center;
            transition: transform 0.2s ease;
        }
        .stat-section:hover {
            transform: scale(1.05);
        }

        .focused-stat-group {
            background-color: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--button-bg); /* Use theme color */
            border-radius: 15px;
            padding: 10px 20px;
            box-shadow: 0 0 15px var(--button-hover-bg);
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 20px;
        }
        .section-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .section-value {
            font-size: 1.5em;
            font-weight: bold;
        }
        #lives-section .section-value::before {
            content: '‚ù§Ô∏è';
            margin-right: 8px;
            font-size: 0.8em;
        }
        #score-display {
            font-size: 1.5em;
            font-weight: bold;
        }

        /* --- Progress Bar --- */
        .level-progress-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        #level-progress-container {
            width: 120px;
            height: 15px;
            background-color: rgba(255, 255, 255, .3);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,.2);
        }
        #level-progress-bar {
            height: 100%;
            background: linear-gradient(to right, #ffeb3b, #ffd700);
            transition: width .5s cubic-bezier(.25,1,.5,1);
            width: 0%; /* Start at 0% */
        }

        /* --- Target Display --- */
        #main-target-display {
            position: fixed;
            top: 140px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--target-bg);
            color: var(--text-color);
            font-size: 80px; /* Reverted font size */
            font-weight: bold;
            width: 150px; /* Reverted size */
            height: 150px; /* Reverted size */
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 25px; /* Reverted border-radius */
            border: 5px solid #fff;
            box-shadow: 0 4px 10px rgba(0, 0, 0, .25);
            z-index: 99;
        }

        /* --- Game Container & Bubbles --- */
        #game-container {
            position: relative;
            width: 100%;
            overflow: hidden;
            padding-top: 200px; /* Space for the target display */
            flex-grow: 1;
        }

        .bubble {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 80px; /* Reverted size */
            height: 80px; /* Reverted size */
            /* background: var(--bubble-bg); */ /* Removed for dynamic coloring */
            border-radius: 50%;
            box-shadow: 0 4px 8px var(--bubble-shadow), inset 0 -5px 10px rgba(255,255,255,.7);
            font-size: 32px; /* Reverted font size */
            font-weight: bold;
            cursor: pointer;
            transition: transform .08s ease-out;
            will-change: transform, top;
            touch-action: none;
        }
        .bubble:active {
            transform: scale(0.95);
        }
        #game-container.font-large .bubble {
            font-size: 48px; /* Reverted font size */
            width: 100px; /* Reverted size */
            height: 100px; /* Reverted size */
        }

        /* --- UI Panel --- */
        #ui-panel {
            background-color: var(--control-panel-bg);
            padding: 10px 15px;
            border-top: 1px solid rgba(255,255,255,0.2);
            z-index: 100;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
            color: var(--header-text);
        }

        #controls-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .control-button {
            padding: 10px 15px;
            font-size: 1.1em;
            font-weight: bold;
            color: var(--text-color); /* Dark text for contrast on white */
            background-color: #ffffff4d;
            border: 1px solid #ddd; /* Subtle border */
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all .2s;
        }
        .control-button:hover {
            background-color: #f0f0f0; /* Light grey on hover */
            transform: translateY(-1px);
        }
        .control-button:active {
            transform: scale(0.98);
        }
        .control-button:focus {
            outline: none;
            background-color: #ffffff4d;
        }
        .control-button.play-pause-btn.paused {
            background-color: #78909c;
            color: white;
        }
        .control-button.play-pause-btn.paused:hover {
            background-color: #546e7a;
        }
        
        #font-toggle-btn {
            /* Keep the same style as other buttons now */
        }

        #font-toggle-btn.active {
            background-color: var(--button-bg); /* Yellow to indicate active */
            color: var(--button-text-color);
            border-color: var(--button-hover-bg);
            box-shadow: 0 0 10px var(--button-bg);
        }

        /* --- Settings Panel --- */
        #settings-panel {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 6000; /* On top of everything */
            justify-content: center;
            align-items: center;
        }

        #settings-panel.visible {
            display: flex; /* Show the panel */
        }

        #settings-content {
            background-color: var(--bg-color);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 320px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .slider-group {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.2em;
        }

        

        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            header {
                padding: 10px;
                gap: 10px;
            }
            .section-value {
                font-size: 1.2em;
            }
            #main-target-display {
                top: 120px;
                width: 120px;
                height: 120px;
                font-size: 60px;
            }
            #game-container {
                padding-top: 120px;
            }
            .control-button {
                padding: 10px 15px;
                font-size: 1.1em;
            }
        }

        @media (max-width: 480px) {
            #highscore-section {
                display: none;
            }
            header {
                flex-direction: row;
                justify-content: space-around;
            }
            #main-target-display {
                top: 150px;
                width: 120px;
                height: 120px;
                font-size: 60px;
            }
            #game-container {
                padding-top: 130px;
            }
            #ui-panel {
                padding: 10px;
            }
            #controls-wrapper {
                gap: 10px;
            }
            .control-button {
                padding: 8px 12px;
                font-size: 1em;
            }
        }

        @media (max-width: 400px) {
            header {
                justify-content: space-between; /* Distribute items evenly */
            }
            .focused-stat-group {
                padding: 10px; /* Reduce padding */
                gap: 10px;
            }
            .stat-section {
                flex-grow: 1; /* Allow sections to grow and fill space */
                flex-basis: 0; /* Reset basis */
            }
        }

        @media (max-width: 340px) {
            .section-value {
                font-size: 1em; /* Further reduce font size */
            }
            .focused-stat-group {
                padding: 8px; /* Further reduce padding */
                gap: 8px;
            }
        }

        @media (max-width: 320px) {
            .focused-stat-group {
                flex-direction: column; /* Stack level and progress vertically */
                gap: 5px;
            }
            #main-target-display {
                top: 180px; /* Adjust position due to taller header */
            }
            #game-container {
                padding-top: 160px; /* Adjust padding due to taller header */
            }
        }
    </style>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DJ0XZDFQ4B"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-DJ0XZDFQ4B');
</script>
</head>
<body>

    <div id="start-screen-overlay" role="dialog" aria-label="Layar Mulai">
        <div>
            <h1 id="start-screen-title">Tangkap Huruf</h1>
            <p id="start-screen-text">Siap berpetualang dengan huruf? Pilih modemu di bawah!</p>
            <div id="lang-selection-container">
                <button class="lang-select-btn" data-lang="hijaiyah">Hijaiyah</button>
                <button class="lang-select-btn" data-lang="indonesia">Alfabet (ID)</button>
                <button class="lang-select-btn" data-lang="inggris">Alphabet (EN)</button>
                <button class="lang-select-btn" data-lang="mixed">Campuran</button>
            </div>
            <p style="font-size:.85em;margin-top:15px;opacity:.9">(Tekan salah satu tombol untuk mengizinkan suara)</p>
        </div>
    </div>

    <header>
        <div class="stat-section" id="lives-section">
            <div class="section-label">Nyawa</div>
            <div class="section-value"><span id="lives">3</span></div>
        </div>
        <div class="focused-stat-group">
            <div class="stat-section" id="level-section" style="padding: 0;">
                <div class="section-label">Level</div>
                <div class="section-value"><span id="level">1</span></div>
                <div id="mode-display" class="section-label" style="margin-top: 4px; font-size: 0.8em; font-weight: bold;"></div>
            </div>
            <div class="level-progress-group">
                 <div class="section-label">Progress</div>
                 <div id="level-progress-container">
                    <div id="level-progress-bar"></div>
                </div>
            </div>
        </div>
        <div class="stat-section">
            <div class="section-label">Skor</div>
            <div id="score-display"><span id="score">0</span></div>
        </div>
        <div class="stat-section" id="highscore-section">
            <div class="section-label">Rekor</div>
            <div class="section-value"><span id="highscore">0</span></div>
        </div>
    </header>

    <div id="main-target-display" aria-live="polite">...</div>

    <div id="game-container" aria-hidden="false"></div>

    <div id="settings-panel">
        <div id="settings-content">
            <h3 style="margin-top: 0; text-align: center; color: var(--text-color);">Pengaturan</h3>
            
            <button id="font-toggle-btn" class="control-button toggle-btn">Ukuran: Kecil</button>
            
            <div class="slider-group" style="margin: 15px 0;">
                <label for="music-volume-slider" style="font-size: 1.5em;">üéµ</label>
                <input type="range" id="music-volume-slider" min="0" max="1" step="0.05" value="0.1" style="width: 100%;">
            </div>
            
            <button id="share-btn" class="control-button">Bagikan Skor</button>
            
            <p style="margin: 15px 0; text-align: center; font-size: 0.8em; color: #666;">Created by zufar.muh@gmail.com</p>
            
            <button id="close-settings-btn" class="control-button" style="width: 100%; background-color: var(--button-bg);">Tutup</button>
        </div>
    </div>

    <div id="ui-panel">
        <div id="controls-wrapper">
            <button id="play-pause-btn" class="control-button play-pause-btn paused">‚ñ∂Ô∏è</button>
            <button id="repeat-btn" class="control-button">üîÅ</button>
            <button id="new-target-btn" class="control-button">üîÄ</button>
            <button id="settings-btn" class="control-button">‚öôÔ∏è</button>
        </div>
    </div>

    <script src="audio_data.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Elements
        const gameContainer = document.getElementById('game-container');
        const mainTargetDisplay = document.getElementById('main-target-display');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const scoreSpan = document.getElementById('score');
        const livesSpan = document.getElementById('lives');
        const levelSpan = document.getElementById('level');
        const levelProgressBar = document.getElementById('level-progress-bar');
        const musicVolumeSlider = document.getElementById('music-volume-slider');
        const fontToggleBtn = document.getElementById('font-toggle-btn');
        const newTargetBtn = document.getElementById('new-target-btn');
        const repeatBtn = document.getElementById('repeat-btn');
        const shareBtn = document.getElementById('share-btn');
        const startScreen = document.getElementById('start-screen-overlay');
        const highscoreSpan = document.getElementById('highscore');
        const modeDisplay = document.getElementById('mode-display');
        const settingsPanel = document.getElementById('settings-panel');
        const settingsBtn = document.getElementById('settings-btn');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const body = document.body;

        // Letter Sets
        const hijaiyahLetters = ['ÿß','ÿ®','ÿ™','ÿ´','ÿ¨','ÿ≠','ÿÆ','ÿØ','ÿ∞','ÿ±','ÿ≤','ÿ≥','ÿ¥','ÿµ','ÿ∂','ÿ∑','ÿ∏','ÿπ','ÿ∫','ŸÅ','ŸÇ','ŸÉ','ŸÑ','ŸÖ','ŸÜ','Ÿà','Ÿá','ÿ°','Ÿä'];
        const indonesianLetters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
        const englishLetters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
        // const audioPrompts = ["Tangkap", "Ayo temukan", "Mana huruf"]; // Removed for focus

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function getHighScore(mode) {
            return parseInt(localStorage.getItem(`highScore_${mode}`) || '0', 10);
        }

        function setHighScore(mode, score) {
            localStorage.setItem(`highScore_${mode}`, score);
        }

        let shuffledLetters = [];
        let currentLetterIndex = 0;

        function initializeLetterPool() {
            let letterPool;
            switch (gameState.alphabetType) {
                case 'hijaiyah':
                    letterPool = hijaiyahLetters;
                    break;
                case 'indonesia':
                    letterPool = indonesianLetters;
                    break;
                case 'inggris':
                    letterPool = englishLetters;
                    break;
                case 'mixed':
                    letterPool = [...hijaiyahLetters, ...indonesianLetters];
                    break;
                default:
                    letterPool = hijaiyahLetters;
            }
            shuffledLetters = shuffleArray([...letterPool]);
            currentLetterIndex = 0;
        }

        const MAX_LEVEL = 20;
        const LEVEL_THRESHOLDS = {};
        for (let i = 2; i <= MAX_LEVEL; i++) {
            LEVEL_THRESHOLDS[i] = (i - 1) * 100;
        }

        const placeholderBase64 ='SUQzBAAAAAAB9JVRWFgAAAASAAADTGF2ZjU2LjM2LjEwMAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV6urq6urq6urq6urq6urq6urq6urq6urq6v////////////////////////////////8AAAAATGF2YzU2LjQxAAAAAAAAAAAAAAAAAAAAAAA//MUZAAAAAGkAAAAAAAAA0gAAAAATEFN//MUZAMAAAGkAAAAAAAAA0gAAAAARTMu//MUZAYAAAGkAAAAAAAAA0gAAAAA//MUZAgAAAGkAAAAAAAAA0gAAAAA';

        const letterSounds = {
			'ÿß': { name: 'alif', base64: placeholderBase64_alif }, 'ÿ®': { name: 'baak', base64: placeholderBase64_baak }, 'ÿ™': { name: 'taak', base64: placeholderBase64_taak }, 'ÿ´': { name: 'stsak', base64: placeholderBase64_stsak }, 'ÿ¨': { name: 'jiim', base64: placeholderBase64_jiim }, 'ÿ≠': { name: 'khaak', base64: placeholderBase64_khaak }, 'ÿÆ': { name: 'khook', base64: placeholderBase64_khook }, 'ÿØ': { name: 'dal', base64: placeholderBase64_dal }, 'ÿ∞': { name: 'dzal', base64: placeholderBase64_dzal }, 'ÿ±': { name: 'rok', base64: placeholderBase64_rok }, 'ÿ≤': { name: 'zain', base64: placeholderBase64_zain }, 'ÿ≥': { name: 'sin', base64: placeholderBase64_sin }, 'ÿ¥': { name: 'syin', base64: placeholderBase64_syin }, 'ÿµ': { name: 'shodek', base64: placeholderBase64_shodek }, 'ÿ∂': { name: 'dhodek', base64: placeholderBase64_dhodek }, 'ÿ∑': { name: 'thok', base64: placeholderBase64_thok }, 'ÿ∏': { name: 'dzok', base64: placeholderBase64_dzok }, 'ÿπ': { name: 'ain', base64: placeholderBase64_ain }, 'ÿ∫': { name: 'ghain', base64: placeholderBase64_ghain }, 'ŸÅ': { name: 'fak', base64: placeholderBase64_fak }, 'ŸÇ': { name: 'qof', base64: placeholderBase64_qof }, 'ŸÉ': { name: 'kaf', base64: placeholderBase64_kaf }, 'ŸÑ': { name: 'laam', base64: placeholderBase64_laam }, 'ŸÖ': { name: 'mimm', base64: placeholderBase64_mimm }, 'ŸÜ': { name: 'nunn', base64: placeholderBase64_nunn }, 'Ÿà': { name: 'wawu', base64: placeholderBase64_wawu }, 'Ÿá': { name: 'hak', base64: placeholderBase64_hak }, 'ÿ°': { name: 'hamzah', base64: placeholderBase64_hamzah }, 'Ÿä': { name: 'yak', base64: placeholderBase64_yak }
		};

        let gameState = { score:0, lives:3, currentLevel:1, isPlaying:false, currentTarget:'', gameSpeed:1.5, volume:1, isLargeFont:false, musicVolume: 0.1, windDirection: 0, windStrength: 0.5, windIntervalId: null, alphabetType: 'hijaiyah', lastLatinLang: 'en-US' };
        const audioCtx = (window.AudioContext || window.webkitAudioContext) ? new (window.AudioContext || window.webkitAudioContext)() : null;

        function ensureAudioReadyOnGesture() {
            if (audioCtx && audioCtx.state === 'suspended') {
                try { audioCtx.resume(); console.debug('AudioContext resumed'); } catch (e){ console.debug('AudioContext resume failed', e); }
            }
            if ('speechSynthesis' in window && window.speechSynthesis.getVoices().length === 0) {
                window.speechSynthesis.getVoices();
            }
        }

        function speakFallback(text, lang='id-ID') {
            if (!('speechSynthesis' in window) || gameState.volume === 0) return;
            try {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.lang = lang;
                u.volume = Math.max(0, Math.min(1, gameState.volume));
                window.speechSynthesis.speak(u);
            } catch (e) { console.debug('TTS fallback failed', e); }
        }

        const feedbackAudioCache = {};

        function synthFallbackFeedback(type) {
            if (!audioCtx) { speakFallback(type === 'correct' ? 'Benar' : 'Salah', 'id-ID'); return; }
            try {
                const masterVolume = Math.max(0, Math.min(1, gameState.volume * 0.7));
                if (masterVolume === 0) return;
                const now = audioCtx.currentTime;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                gain.gain.setValueAtTime(0.0001, now);
                if (type === 'correct') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(880, now);
                    gain.gain.exponentialRampToValueAtTime(masterVolume * 0.3, now + 0.01);
                    gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.22);
                    osc.stop(now + 0.25);
                } else {
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(220, now);
                    gain.gain.exponentialRampToValueAtTime(masterVolume * 0.25, now + 0.01);
                    gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.35);
                    osc.stop(now + 0.35);
                }
                osc.connect(gain); gain.connect(audioCtx.destination); osc.start(now);
            } catch (e) { console.debug('synthFallbackFeedback failed', e); speakFallback(type === 'correct' ? 'Benar' : 'Salah', 'id-ID'); }
        }

        function playPopSound() {
            if (!audioCtx || gameState.volume === 0) return;
            try {
                const now = audioCtx.currentTime;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(440, now);
                osc.frequency.exponentialRampToValueAtTime(880, now + 0.1);
                gain.gain.setValueAtTime(gameState.volume * 0.5, now);
                gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.1);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(now);
                osc.stop(now + 0.1);
            } catch (e) { console.debug('playPopSound failed', e); }
        }

        function playLevelUpSound() {
            if (!audioCtx || gameState.volume === 0) return;
            try {
                const now = audioCtx.currentTime;
                const gain = audioCtx.createGain();
                gain.connect(audioCtx.destination);
                
                const notes = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
                notes.forEach((freq, i) => {
                    const osc = audioCtx.createOscillator();
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(freq, now + i * 0.1);
                    osc.connect(gain);
                    gain.gain.setValueAtTime(gameState.volume * 0.4, now + i * 0.1);
                    gain.gain.exponentialRampToValueAtTime(0.0001, now + (i + 1) * 0.1);
                    osc.start(now + i * 0.1);
                    osc.stop(now + (i + 1) * 0.1);
                });
            } catch (e) { console.debug('playLevelUpSound failed', e); }
        }

        const letterAudioCache = {};
        function playLetterSound() {
            const currentLetter = gameState.currentTarget;
            if (!currentLetter) return;

            const isHijaiyah = hijaiyahLetters.includes(currentLetter);
            // const randomPrompt = audioPrompts[Math.floor(Math.random() * audioPrompts.length)]; // Removed for focus

            if (isHijaiyah) {
                const soundData = letterSounds[currentLetter];
                if (!soundData) return;

                if (letterAudioCache[currentLetter]) {
                    const audio = letterAudioCache[currentLetter];
                    audio.currentTime = 0;
                    audio.volume = Math.max(0, Math.min(1, gameState.volume));
                    audio.play().catch(e => console.debug("Letter sound replay failed", e));
                    return;
                }
                if (soundData.base64 && soundData.base64 !== placeholderBase64) {
                    const audio = new Audio(`data:audio/mp3;base64,${soundData.base64}`);
                    audio.volume = Math.max(0, Math.min(1, gameState.volume));
                    letterAudioCache[currentLetter] = audio;
                    audio.play().catch(e => { console.debug("Base64 audio play failed, using TTS fallback.", e); speakFallback(soundData.name, 'id-ID'); });
                } else {
                    speakFallback(soundData.name, 'id-ID');
                }
            } else {
                // Logic for Latin letters
                let lang;
                if (gameState.alphabetType === 'inggris') {
                    lang = 'en-US';
                } else if (gameState.alphabetType === 'indonesia') {
                    lang = 'id-ID';
                } else { // This is the 'mixed' mode
                    // Alternate between Indonesian and English accent
                    if (gameState.lastLatinLang === 'en-US') {
                        lang = 'id-ID';
                        gameState.lastLatinLang = 'id-ID';
                    } else {
                        lang = 'en-US';
                        gameState.lastLatinLang = 'en-US';
                    }
                }
                speakFallback(currentLetter, lang);
            }
        }

        function playFeedbackSound(type) {
            const soundId = type;
            const base64Data = type === 'correct' ? correctSoundBase64 : incorrectSoundBase64;
            if (feedbackAudioCache[soundId]) {
                const audio = feedbackAudioCache[soundId];
                audio.currentTime = 0;
                audio.volume = Math.max(0, Math.min(1, gameState.volume));
                audio.play().catch(e => { console.debug(`Cached feedback sound failed for '${soundId}'. Using fallback.`, e); synthFallbackFeedback(type); });
                return;
            }
            if (base64Data) {
                try {
                    const audio = new Audio(`data:audio/mp3;base64,${base64Data}`);
                    audio.volume = Math.max(0, Math.min(1, gameState.volume));
                    feedbackAudioCache[soundId] = audio;
                    audio.play().catch(e => { console.debug(`New feedback sound failed for '${soundId}'. Using fallback.`, e); synthFallbackFeedback(type); });
                } catch (e) { console.debug(`Error creating audio from Base64 for '${soundId}'. Using fallback.`, e); synthFallbackFeedback(type); }
            } else {
                synthFallbackFeedback(type);
            }
        }

        const music = {
            audioElement: null,
            init: function() {
                if (this.audioElement) return;
                this.audioElement = new Audio();
                this.audioElement.loop = true;
                this.audioElement.src = `data:audio/mp3;base64,${musicBase64}`;
            },
            start: function() {
                this.init();
                this.audioElement.volume = gameState.musicVolume;
                const playPromise = this.audioElement.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => { console.debug("Music play was prevented.", error); });
                }
            },
            stop: function() {
                if (this.audioElement) { this.audioElement.pause(); this.audioElement.currentTime = 0; }
            }
        };

        let rafId = null; let lastSpawnTime = 0;
        function startLoop() { lastSpawnTime = performance.now(); if (!rafId) rafId = requestAnimationFrame(loop); }
        function stopLoop() { if (rafId) { cancelAnimationFrame(rafId); rafId = null; } }

        function updateWind() {
            const random = Math.random();
            if (random < 0.4) gameState.windDirection = -1;
            else if (random < 0.8) gameState.windDirection = 1;
            else gameState.windDirection = 0;
        }

        function loop(now) {
            const spawnInterval = 2000 / Math.max(0.01, gameState.gameSpeed);
            if (now - lastSpawnTime >= spawnInterval && gameState.isPlaying) { createBubble(); lastSpawnTime = now; }

            const bubbles = Array.from(document.querySelectorAll('.bubble'));
            const containerHeight = gameContainer.clientHeight;
            const containerWidth = gameContainer.clientWidth;

            bubbles.forEach(bubble => {
                let top = parseFloat(bubble.style.top || '-120');
                let left = parseFloat(bubble.style.left);
                if (gameState.isPlaying) {
                    top += gameState.gameSpeed;
                    if (gameState.currentLevel >= 4) left += gameState.windDirection * gameState.windStrength;
                    if (bubble.dataset.vx) left += parseFloat(bubble.dataset.vx) * (gameState.gameSpeed / 2);
                }
                const bubbleWidth = bubble.offsetWidth;
                if (left < 0 || left > containerWidth - bubbleWidth) {
                    if (bubble.dataset.vx) bubble.dataset.vx = -parseFloat(bubble.dataset.vx);
                    left = Math.max(0, Math.min(left, containerWidth - bubbleWidth));
                }
                if (top > containerHeight + 50) bubble.remove();
                else { bubble.style.top = top + 'px'; bubble.style.left = left + 'px'; }
            });

            if (gameState.isPlaying || document.querySelectorAll('.bubble').length > 0) {
                rafId = requestAnimationFrame(loop);
            } else {
                stopLoop();
            }
        }

        function createBubble() {
            const MAX_BUBBLES = 40;
            if (document.querySelectorAll('.bubble').length >= MAX_BUBBLES) return;
            const bubble = document.createElement('div');
            bubble.className = 'bubble';

            const hue = Math.floor(Math.random() * 360);
            const saturation = 70 + Math.random() * 25;
            const lightness = 85 + Math.random() * 10;
            bubble.style.background = `hsl(${hue}, ${saturation}%, ${lightness}%)`;

            let letter;
            if (Math.random() < 0.35 && gameState.currentTarget) {
                letter = gameState.currentTarget;
            } else {
                let letterPool;
                switch (gameState.alphabetType) {
                    case 'hijaiyah':
                        letterPool = hijaiyahLetters;
                        break;
                    case 'indonesia':
                        letterPool = indonesianLetters;
                        break;
                    case 'inggris':
                        letterPool = englishLetters;
                        break;
                    case 'mixed':
                        letterPool = [...hijaiyahLetters, ...indonesianLetters];
                        break;
                    default:
                        letterPool = hijaiyahLetters;
                }
                letter = letterPool[Math.floor(Math.random() * letterPool.length)];
            }
            bubble.textContent = letter;
            bubble.dataset.type = 'letter';
            const bw = (gameState.isLargeFont) ? 100 : 80;
            const left = Math.max(5, Math.random() * (gameContainer.clientWidth - bw - 10));
            bubble.style.left = left + 'px';
            bubble.style.top = '-120px';
            if (gameState.currentLevel >= 11) {
                bubble.dataset.vx = (Math.random() - 0.5) * 2;
            }
            bubble.addEventListener('pointerdown', handleBubbleClick);
            gameContainer.appendChild(bubble);
        }

        let lastClickAt = 0;
        function handleBubbleClick(event) {
            if (!gameState.isPlaying) return;
            playPopSound(); // Play pop sound on any bubble interaction
            const now = Date.now();
            if (now - lastClickAt < 300) return;
            lastClickAt = now;
            const targetBubble = event.currentTarget;
            if (!targetBubble) return;
            const clickedLetter = targetBubble.textContent;
            if (!clickedLetter) return;
            if (clickedLetter === gameState.currentTarget) {
                playFeedbackSound('correct');
                triggerConfetti();
                dramatizeEffect('correct');
                gameState.score += 10;
                targetBubble.remove();
                setTimeout(() => { setNewTarget(true); }, 1000);
                checkLevelUp();
            } else {
                playFeedbackSound('incorrect');
                dramatizeEffect('wrong');
                gameState.lives--;
                if (gameState.lives <= 0) {
                    gameOver();
                }
            }
            updateUI();
        }

        function setNewTarget(playSoundOnSet = true) {
            if (currentLetterIndex >= shuffledLetters.length) {
                initializeLetterPool();
            }
            gameState.currentTarget = shuffledLetters[currentLetterIndex];
            currentLetterIndex++;
            updateUI();
            if (playSoundOnSet && gameState.isPlaying) repeatTargetSound();
        }

        function updateUI() {
            mainTargetDisplay.textContent = gameState.currentTarget || '...';
            scoreSpan.textContent = gameState.score;
            livesSpan.textContent = gameState.lives;
            levelSpan.textContent = gameState.currentLevel;
            highscoreSpan.textContent = getHighScore(gameState.alphabetType);
            gameContainer.classList.toggle('font-large', gameState.isLargeFont);
            fontToggleBtn.classList.toggle('active', gameState.isLargeFont);
            fontToggleBtn.textContent = gameState.isLargeFont ? 'Ukuran: Besar' : 'Ukuran: Kecil';

            // Update level progress bar
            let progress = 0;
            if (gameState.currentLevel < MAX_LEVEL) {
                const currentLevelThreshold = LEVEL_THRESHOLDS[gameState.currentLevel] || 0;
                const nextLevelThreshold = LEVEL_THRESHOLDS[gameState.currentLevel + 1];
                if (nextLevelThreshold) {
                    const scoreNeededForNextLevel = nextLevelThreshold - currentLevelThreshold;
                    const scoreAchievedInCurrentLevel = gameState.score - currentLevelThreshold;
                    progress = (scoreAchievedInCurrentLevel / scoreNeededForNextLevel) * 100;
                    progress = Math.max(0, Math.min(100, progress));
                }
            } else {
                progress = 100;
            }
            levelProgressBar.style.width = `${progress}%`;
        }

        function checkLevelUp() {
            if (gameState.currentLevel < MAX_LEVEL) {
                const nextLevel = gameState.currentLevel + 1;
                if (LEVEL_THRESHOLDS[nextLevel] && gameState.score >= LEVEL_THRESHOLDS[nextLevel]) {
                    gameState.currentLevel = nextLevel;
                    if (gameState.currentLevel <= 10) gameState.gameSpeed += 0.2;
                    else if (gameState.currentLevel === 11) gameState.gameSpeed = 1.5;
                    else gameState.gameSpeed += 0.2;
                    
                    playLevelUpSound(); // Play sound on level up

                    if (gameState.currentLevel === MAX_LEVEL) congratulationsScreen();
                    else levelUpEffect();
                    updateUI();
                }
            }
        }

        function levelUpEffect() {
            const levelUpDiv = document.createElement('div');
            levelUpDiv.textContent = `Level ${gameState.currentLevel}!`;
            levelUpDiv.style.cssText = `position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 4em; font-weight: bold; color: #4CAF50; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); z-index: 5000; opacity: 0; animation: fadeAndScale 1.5s forwards;`;
            document.body.appendChild(levelUpDiv);
            const styleSheet = document.styleSheets[0];
            const keyframes = `@keyframes fadeAndScale { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); } 50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); } 100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); } }`;
            try { styleSheet.insertRule(keyframes, styleSheet.cssRules.length); } catch(e) { console.debug("Failed to insert keyframe", e)}
            setTimeout(() => { levelUpDiv.remove(); }, 1500);
        }

        function repeatTargetSound() { playLetterSound(); }
        function dramatizeEffect(type) { body.classList.remove('flash-correct','flash-wrong','shake-effect'); void body.offsetWidth; if (type === 'correct') { body.classList.add('flash-correct'); } else { body.classList.add('shake-effect','flash-wrong'); } setTimeout(()=>{ body.classList.remove('flash-correct','flash-wrong','shake-effect'); },600); }
        function triggerConfetti(){ for (let i=0;i<30;i++){ const confetti=document.createElement('div'); confetti.className='confetti'; confetti.style.left=`${Math.random()*100}vw`; confetti.style.top=`${Math.random()*10}vh`; confetti.style.backgroundColor=`hsl(${Math.random()*360},80%,55%)`; confetti.style.animationDelay=`${Math.random()*0.5}s`; confetti.style.transform=`scale(${Math.random()*0.7+0.3})`; body.appendChild(confetti); setTimeout(()=>confetti.remove(),3200);} }

        async function shareGame(title, text) {
            const shareData = {
                title: title || 'Game Edukatif: Tangkap Huruf',
                text: text || 'Ayo mainkan game edukasi seru untuk belajar huruf!',
                url: window.location.href
            };
            try {
                if (navigator.share) {
                    await navigator.share(shareData);
                } else if (navigator.clipboard) {
                    await navigator.clipboard.writeText(`${shareData.text}\n${shareData.url || ''}`);
                    alert('Teks telah disalin ke clipboard.');
                } else {
                    alert('Fitur bagikan tidak didukung pada browser ini.');
                }
            } catch (err) {
                // Known issue: AbortError is thrown when the user cancels the share sheet.
                // We can safely ignore this error.
                if (err.name !== 'AbortError') {
                    console.error('Share failed:', err);
                    alert('Gagal membagikan karena ada kesalahan.');
                }
            }
        }

        function addEventListeners(){
            const langSelectBtns = document.querySelectorAll('.lang-select-btn');
            langSelectBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const selectedLang = e.target.dataset.lang;
                    const selectedModeName = e.target.textContent;
                    gameState.alphabetType = selectedLang;
                    modeDisplay.textContent = selectedModeName;
                    
                    // Update highscore display for the selected mode
                    highscoreSpan.textContent = getHighScore(selectedLang);

                    const gameTitle = document.querySelector('head > title');
                    const shareText = 'Ayo mainkan game edukasi seru untuk belajar huruf!';
                    let titleText = 'Game: Tangkap Huruf';
                    if (selectedLang === 'hijaiyah') {
                        titleText = 'Game: Tangkap Huruf Hijaiyah';
                    } else if (selectedLang === 'indonesia') {
                        titleText = 'Game: Tangkap Huruf Indonesia';
                    } else if (selectedLang === 'inggris') {
                        titleText = 'Game: Tangkap Huruf Inggris';
                    } else if (selectedLang === 'mixed') {
                        titleText = 'Game: Tangkap Huruf Gabungan';
                    }
                    gameTitle.textContent = titleText;
                    
                    // Set the onclick handler for the share button with the correct context
                    shareBtn.onclick = () => shareGame(titleText, shareText);

                    ensureAudioReadyOnGesture();
                    startScreen.style.display = 'none';
                    
                    // Reset and start game
                    gameState.score = 0;
                    gameState.lives = 3;
                    gameState.currentLevel = 1;
                    initializeLetterPool();
                    setNewTarget(false);
                    updateUI();
                    if (!gameState.isPlaying) togglePlayPause();
                });
            });

            playPauseBtn.addEventListener('click', () => { togglePlayPause(); });
            repeatBtn.addEventListener('click', () => { if (gameState.currentTarget) repeatTargetSound(); });
            newTargetBtn.addEventListener('click', () => { setNewTarget(gameState.isPlaying); });
            fontToggleBtn.addEventListener('click', () => { gameState.isLargeFont = !gameState.isLargeFont; updateUI(); });
            musicVolumeSlider.addEventListener('input', (e) => {
                gameState.musicVolume = parseFloat(e.target.value) || 0.1;
                if (music.audioElement) {
                    music.audioElement.volume = gameState.musicVolume;
                }
            });
            
            // The shareBtn's onclick is now set dynamically when a language is selected.

            // Settings Panel Listeners
            settingsBtn.addEventListener('click', () => {
                settingsPanel.classList.add('visible');
            });
            closeSettingsBtn.addEventListener('click', () => {
                settingsPanel.classList.remove('visible');
            });
            settingsPanel.addEventListener('click', (e) => {
                if (e.target === settingsPanel) { // Close if clicking on the background
                    settingsPanel.classList.remove('visible');
                }
            });

            document.addEventListener('keydown', (e)=>{ if (e.key === ' ' || e.key === 'Spacebar') e.preventDefault(); });
            window.addEventListener('resize', () => {
                const bubbles = document.querySelectorAll('.bubble');
                bubbles.forEach(b => {
                    if (parseFloat(b.style.left) > gameContainer.clientWidth - 40) b.remove();
                });
            });
        }

        function togglePlayPause(){
            gameState.isPlaying = !gameState.isPlaying;
            if (gameState.isPlaying){
                playPauseBtn.innerHTML = '‚è∏Ô∏è';
                playPauseBtn.classList.remove('paused');
                if (!rafId) startLoop();
                repeatTargetSound();
                music.start();
                if (!gameState.windIntervalId) {
                    gameState.windIntervalId = setInterval(updateWind, 10000);
                }
            } else {
                playPauseBtn.innerHTML = '‚ñ∂Ô∏è';
                playPauseBtn.classList.add('paused');
                music.stop();
                if (gameState.windIntervalId) {
                    clearInterval(gameState.windIntervalId);
                    gameState.windIntervalId = null;
                }
            }
        }

        function gameOver() {
            stopLoop();
            music.stop();
            if (gameState.windIntervalId) {
                clearInterval(gameState.windIntervalId);
                gameState.windIntervalId = null;
                gameState.windDirection = 0;
            }
            gameState.isPlaying = false;
            playPauseBtn.innerHTML = '‚ñ∂Ô∏è';
            playPauseBtn.classList.add('paused');

            // Check for new high score BEFORE resetting the score
            const currentHighScore = getHighScore(gameState.alphabetType);
            if (gameState.score > currentHighScore) {
                setHighScore(gameState.alphabetType, gameState.score);
            }

            const startScreenTitle = document.getElementById('start-screen-title');
            const startScreenText = document.getElementById('start-screen-text');

            startScreenTitle.textContent = 'Game Over!';
            startScreenText.innerHTML = `Skor Akhir Anda: ${gameState.score}<br>Jangan menyerah! Coba lagi dengan mode lain?`;
            startScreen.style.display = 'flex';

            // Reset core stats but wait for user to select new mode
            gameState.score = 0;
            gameState.lives = 3;
            gameState.currentLevel = 1;
            updateUI();
        }

        function congratulationsScreen() {
            stopLoop();
            music.stop();
            if (gameState.windIntervalId) {
                clearInterval(gameState.windIntervalId);
                gameState.windIntervalId = null;
                gameState.windDirection = 0;
            }
            gameState.isPlaying = false;
            playPauseBtn.innerHTML = '‚ñ∂Ô∏è';
            playPauseBtn.classList.add('paused');

            // Check for new high score BEFORE resetting the score
            const currentHighScore = getHighScore(gameState.alphabetType);
            if (gameState.score > currentHighScore) {
                setHighScore(gameState.alphabetType, gameState.score);
            }

            const startScreenTitle = document.getElementById('start-screen-title');
            const startScreenText = document.getElementById('start-screen-text');

            startScreenTitle.textContent = 'Selamat!';
            startScreenText.innerHTML = `Anda telah mencapai Level Maksimal (${MAX_LEVEL})!<br>Skor Akhir Anda: ${gameState.score}<br>Luar biasa! Kamu menguasai level ini. Tantang dirimu di mode lain?`;
            startScreen.style.display = 'flex';
            
            // Reset core stats but wait for user to select new mode
            gameState.score = 0;
            gameState.lives = 3;
            gameState.currentLevel = 1;
            updateUI();
        }

        addEventListeners();
        // Don't set initial target, wait for user selection
        // setNewTarget(false); 
        updateUI();

        console.info('Game audio is now fully offline using Web Audio API and Speech Synthesis.');
    });
    </script>

</body>
</html>
